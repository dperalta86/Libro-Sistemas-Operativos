name: Makefile CI

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-xetex \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-lang-spanish \
            lmodern \
            fonts-dejavu \
            fonts-liberation \
            fonts-noto \
            librsvg2-bin

      - name: Install Mermaid CLI
        run: |
          sudo npm install -g @mermaid-js/mermaid-cli
          # Verificar instalación
          mmdc --version

      - name: Verify pandoc and xelatex
        run: |
          pandoc --version
          xelatex --version
          
      - name: List available fonts (debug)
        run: |
          fc-list | grep -i "dejavu\|liberation\|noto" | head -10

      - name: Build PDF
        run: |
          # Ejecutar make con más verbosidad para debugging
          make debug
          make all

      - name: List generated files (debug)
        run: |
          ls -la build/
          file build/*.pdf || echo "No PDF found"

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/Introduccion_a_los_Sistemas_Operativos.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
